<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Voice Dungeon Explorer</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 0; background: #111; 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; font-family: Arial, sans-serif; 
        }
        .container { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 600px; padding: 20px; }
        .mic-button {
            width: 300px; height: 300px; border-radius: 50%; background: #222; border: 6px solid #fff;
            color: #ffffff; font-size: 24px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            transition: all 0.2s ease; margin-bottom: 20px;
        }
        .mic-button:active { transform: scale(0.95); }
        .mic-icon { font-size: 60px; margin-bottom: 15px; }
        .listening { background: #004400 !important; border-color: #44ff44 !important; }
        .start-button { background: #000044 !important; border-color: #4444ff !important; }
        .text-display {
            background: rgba(0,0,0,0.8); color: #fff; padding: 20px; border-radius: 10px;
            min-height: 120px; width: 100%; margin-bottom: 20px; font-size: 16px;
            line-height: 1.4; text-align: center; border: 2px solid #444;
        }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
        .control-btn {
            background: #333; color: #fff; border: 1px solid #666; padding: 8px 16px;
            border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.2s;
        }
        .control-btn:hover { background: #555; border-color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <div id="textDisplay" class="text-display">
            Welcome to Voice Dungeon Explorer!<br><br>
            Click the button below to begin your audio adventure.<br>
            Make sure to allow microphone permissions when prompted.
        </div>
        
        <button id="micButton" class="mic-button start-button" onclick="handleClick()" aria-label="Voice command button">
            <div class="mic-icon">🎤</div>
            <div id="micText">TAP TO BEGIN</div>
        </button>
        
        <div class="controls">
            <button class="control-btn" onclick="testSpeech()">Test Speech</button>
            <button class="control-btn" onclick="testMicrophone()">Test Mic</button>
        </div>
    </div>

    <script>
        const micButton = document.getElementById('micButton');
        const micText = document.getElementById('micText');
        const textDisplay = document.getElementById('textDisplay');
        
        function displayText(text) {
            textDisplay.innerHTML = text;
        }
        
        let browserSupport = {
            speechSynthesis: !!(window.speechSynthesis && window.SpeechSynthesisUtterance),
            speechRecognition: !!(window.webkitSpeechRecognition || window.SpeechRecognition),
            https: window.location.protocol === 'https:' || window.location.hostname === 'localhost'
        };
        
        function testSpeech() {
            if (!browserSupport.speechSynthesis) {
                displayText('Speech synthesis not supported. Try Chrome, Edge, or Safari.');
                return;
            }
            try {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance('Testing speech synthesis. If you hear this, speech works.');
                utterance.rate = 0.8;
                utterance.onstart = () => displayText('🔊 Testing speech...');
                utterance.onend = () => displayText('✅ Speech test completed!');
                utterance.onerror = (event) => displayText('❌ Speech test failed: ' + event.error);
                speechSynthesis.speak(utterance);
            } catch (error) {
                displayText('❌ Speech error: ' + error.message);
            }
        }
        
        function testMicrophone() {
            if (!browserSupport.speechRecognition) {
                displayText('Voice recognition not supported. Try Chrome, Edge, or Safari.');
                return;
            }
            if (!browserSupport.https) {
                displayText('Microphone requires HTTPS. Use GitHub Pages.');
                return;
            }
            try {
                const Recognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                const recognition = new Recognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.onstart = () => {
                    displayText('🎤 Say something to test microphone...');
                    micButton.classList.add('listening');
                };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    displayText(`✅ Microphone working! You said: "${transcript}"`);
                    micButton.classList.remove('listening');
                };
                recognition.onerror = (event) => {
                    let errorMsg = 'Microphone test failed: ';
                    switch(event.error) {
                        case 'not-allowed': errorMsg += 'Permission denied. Allow microphone access.'; break;
                        case 'no-speech': errorMsg += 'No speech detected. Try speaking louder.'; break;
                        default: errorMsg += event.error;
                    }
                    displayText('❌ ' + errorMsg);
                    micButton.classList.remove('listening');
                };
                recognition.onend = () => micButton.classList.remove('listening');
                recognition.start();
            } catch (error) {
                displayText('❌ Microphone setup failed: ' + error.message);
            }
        }
        
        const game = {
            player: { 
                class: '', level: 1, health: 100, maxHealth: 100, mana: 50, maxMana: 50, 
                gold: 25, inventory: [], position: { x: 0, y: 0 } 
            },
            currentRoom: null, map: {}, listening: false, started: false, 
            needsClass: true, initialized: false
        };
        
        const classes = {
            warrior: { 
                name: 'Warrior', health: 120, mana: 30, gold: 50, 
                items: ['Iron Sword', 'Health Potion', 'Leather Armor'] 
            },
            mage: { 
                name: 'Mage', health: 80, mana: 100, gold: 75, 
                items: ['Magic Staff', 'Mana Potion', 'Cloth Robes'] 
            },
            rogue: { 
                name: 'Rogue', health: 100, mana: 60, gold: 100, 
                items: ['Steel Dagger', 'Lockpicks', 'Studded Leather'] 
            }
        };
        
        function speak(text, callback) {
            displayText(text);
            if (!browserSupport.speechSynthesis) {
                if (callback) setTimeout(callback, 2000);
                return;
            }
            try {
                speechSynthesis.cancel();
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text.replace(/<[^>]*>/g, ''));
                    utterance.rate = 0.8;
                    if (callback) {
                        utterance.onend = callback;
                        utterance.onerror = callback;
                    }
                    speechSynthesis.speak(utterance);
                }, 100);
            } catch (error) {
                if (callback) setTimeout(callback, 2000);
            }
        }
        
        let recognition = null;
        
        function startListening() {
            if (!browserSupport.speechRecognition || !browserSupport.https) {
                speak('Voice recognition requires HTTPS and a compatible browser.');
                return;
            }
            if (game.listening) { 
                stopListening(); 
                return; 
            }
            try {
                const Recognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                recognition = new Recognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                recognition.onstart = () => {
                    game.listening = true;
                    micButton.classList.add('listening');
                    micText.textContent = 'LISTENING...';
                    displayText('🎤 Listening for your command...');
                };
                
                recognition.onresult = (event) => {
                    const command = event.results[0][0].transcript.toLowerCase().trim();
                    displayText(`You said: "${command}"<br><br>Processing...`);
                    stopListening();
                    setTimeout(() => processCommand(command), 500);
                };
                
                recognition.onerror = (event) => {
                    stopListening();
                    let errorMsg = 'Voice error: ';
                    switch(event.error) {
                        case 'not-allowed': 
                            errorMsg += 'Microphone permission denied'; 
                            break;
                        case 'no-speech': 
                            errorMsg += 'No speech detected'; 
                            break;
                        default: 
                            errorMsg += event.error;
                    }
                    speak(errorMsg);
                };
                
                recognition.onend = () => stopListening();
                recognition.start();
            } catch (error) {
                speak('Failed to start voice recognition: ' + error.message);
                stopListening();
            }
        }
        
        function stopListening() {
            game.listening = false;
            micButton.classList.remove('listening');
            micText.textContent = 'SPEAK';
            if (recognition) {
                try { 
                    recognition.stop(); 
                } catch (e) {}
                recognition = null;
            }
        }
        
        function initializeGame() {
            game.initialized = true;
            micButton.classList.remove('start-button');
            micText.textContent = 'SPEAK';
            const welcome = "Welcome to Voice Dungeon Explorer!<br><br>" +
                "Choose your character class:<br><br>" +
                "Say <strong>WARRIOR</strong> for combat strength<br>" +
                "Say <strong>MAGE</strong> for magical power<br>" +
                "Say <strong>ROGUE</strong> for stealth skills";
            speak(welcome);
        }
        
        function handleClick() {
            if (!game.initialized) {
                initializeGame();
            } else {
                startListening();
            }
        }
        
        function processCommand(command) {
            // Clean up the command
            const cleanCommand = command.toLowerCase().trim();
            
            if (game.needsClass) {
                if (cleanCommand.includes('warrior') || cleanCommand.includes('fighter')) {
                    selectClass('warrior');
                } else if (cleanCommand.includes('mage') || cleanCommand.includes('wizard') || cleanCommand.includes('magic')) {
                    selectClass('mage');
                } else if (cleanCommand.includes('rogue') || cleanCommand.includes('thief') || cleanCommand.includes('assassin')) {
                    selectClass('rogue');
                } else {
                    speak('I heard: "' + cleanCommand + '"<br><br>Please say one of these:<br><strong>WARRIOR</strong>, <strong>MAGE</strong>, or <strong>ROGUE</strong>');
                }
                return;
            }
            
            // Game commands after class selection
            if (cleanCommand.includes('status') || cleanCommand.includes('stats')) {
                characterStatus();
            } else if (cleanCommand.includes('inventory') || cleanCommand.includes('items')) {
                listInventory();
            } else if (cleanCommand.includes('help') || cleanCommand.includes('command')) {
                speak('Available commands:<br><br>STATUS - character info<br>INVENTORY - your items<br>HELP - this message');
            } else {
                speak('Unknown command: "' + cleanCommand + '"<br><br>Say HELP for available commands');
            }
        }
        
        function selectClass(className) {
            const classData = classes[className];
            game.player.class = className;
            game.player.health = classData.health;
            game.player.maxHealth = classData.health;
            game.player.mana = classData.mana;
            game.player.maxMana = classData.mana;
            game.player.gold = classData.gold;
            game.player.inventory = [...classData.items];
            game.needsClass = false;
            game.started = true;
            
            const message = `You have chosen the ${classData.name} class!<br><br>` +
                `Health: ${classData.health}<br>` +
                `Mana: ${classData.mana}<br>` +
                `Gold: ${classData.gold} coins<br><br>` +
                `Starting equipment: ${classData.items.join(', ')}<br><br>` +
                `Say STATUS to hear your character details or HELP for commands.`;
            
            speak(message);
        }
        
        function characterStatus() {
            const player = game.player;
            const classData = classes[player.class];
            const message = `Character Status:<br><br>` +
                `Class: ${classData.name}<br>` +
                `Level: ${player.level}<br>` +
                `Health: ${player.health}/${player.maxHealth}<br>` +
                `Mana: ${player.mana}/${player.maxMana}<br>` +
                `Gold: ${player.gold} coins`;
            speak(message);
        }
        
        function listInventory() {
            if (game.player.inventory.length === 0) {
                speak('Your inventory is empty.<br><br>You have ' + game.player.gold + ' gold coins.');
                return;
            }
            const message = `Your inventory contains:<br><br>` +
                `${game.player.inventory.join('<br>')}<br><br>` +
                `Gold: ${game.player.gold} coins`;
            speak(message);
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize browser support check
            console.log('Voice Dungeon Explorer loaded');
        });
        
        micButton.addEventListener('contextmenu', (e) => e.preventDefault());
    </script>
</body>
</html>
